<!-- Auto-generated by /work-plan - Updated: 2026-01-30T00:00:00Z -->

# Work Plan: Feature 003 - Agent Behavior Statecharts

## Current Status

| Metric | Value |
|--------|-------|
| **Feature** | 003-agent-behavior-statecharts |
| **Branch** | `feature/003-agent-behavior-statecharts` ‚úì |
| **Progress** | 0/47 tasks (0%) |
| **Current Phase** | Phase 1: Core Types |
| **Status** | ‚è∏Ô∏è Not Started |

## Phase Overview

| Phase | Name | Tasks | Status | Progress | Blocks |
|-------|------|-------|--------|----------|--------|
| 1 | Core Types | T001-T006 | ‚è∏Ô∏è Not Started | 0/6 | ‚Äî |
| 2 | Statechart Engine | T007-T015 | üîí Blocked | 0/9 | Phase 1 |
| 3 | LLM Reasoner | T016-T023 | üîí Blocked | 0/8 | Phase 2 |
| 4 | Timeout Transitions | T024-T029 | üîí Blocked | 0/6 | Phase 2 |
| 5 | Agent Integration | T030-T039 | üîí Blocked | 0/10 | Phase 4 |
| 6 | Queries + Validation | T040-T047 | üîí Blocked | 0/8 | Phase 5 |

## Dependency Graph

```
Phase 1 (Core Types) ‚îÄ‚îÄ‚ñ∫ Phase 2 (Statechart Engine)
                                 ‚îÇ
                                 ‚îú‚îÄ‚îÄ‚ñ∫ Phase 3 (LLM Reasoner)
                                 ‚îÇ
                                 ‚îî‚îÄ‚îÄ‚ñ∫ Phase 4 (Timeouts)
                                           ‚îÇ
                                           ‚ñº
                                 Phase 5 (Agent Integration)
                                           ‚îÇ
                                           ‚ñº
                                 Phase 6 (Queries + Validation)
```

## Recommended Execution Plan

### Phase 1: Core Types (T001-T006)

**Goal**: Define AgentState enum, Transition dataclass, and StateTransition record

| Task | Type | Description |
|------|------|-------------|
| T001 | TEST | Write tests for `AgentState` enum |
| T002 | IMPL | Implement `AgentState` in `prism/statechart/states.py` |
| T003 | TEST | Write tests for `Transition` dataclass |
| T004 | IMPL | Implement `Transition` in `prism/statechart/transitions.py` |
| T005 | TEST | Write tests for `StateTransition` dataclass |
| T006 | IMPL | Implement `StateTransition` in `prism/statechart/transitions.py` |

**Command**: `/implement phase 1`

---

### Phase 2: Statechart Engine (T007-T015)

**Goal**: Build the Statechart class with fire(), valid_triggers(), valid_targets()

| Task | Type | Description |
|------|------|-------------|
| T007 | TEST | Write tests for `Statechart.__init__()` |
| T008 | IMPL | Implement `Statechart.__init__()` |
| T009 | TEST | Write tests for `Statechart.fire()` |
| T010 | IMPL | Implement `Statechart.fire()` basic logic |
| T011 | TEST | Write tests for guard exception handling |
| T012 | IMPL | Implement guard fail-safe behavior |
| T013 | TEST | Write tests for `Statechart.valid_triggers()` |
| T014 | TEST | Write tests for `Statechart.valid_targets()` |
| T015 | IMPL | Implement `valid_triggers()` and `valid_targets()` |

**Command**: `/implement phase 2`

---

### Phase 3: LLM Reasoner (T016-T023)

**Goal**: Build StatechartReasoner for ambiguous transition decisions

| Task | Type | Description |
|------|------|-------------|
| T016 | TEST | Write tests for `StatechartReasoner.__init__()` |
| T017 | IMPL | Implement `StatechartReasoner.__init__()` |
| T018 | TEST | Write tests for reasoner prompt construction |
| T019 | IMPL | Implement `build_reasoner_prompt()` function |
| T020 | TEST | Write tests for `StatechartReasoner.decide()` (async) |
| T021 | IMPL | Implement `StatechartReasoner.decide()` |
| T022 | TEST | Write tests for reasoner parse error handling |
| T023 | IMPL | Implement reasoner error handling |

**Command**: `/implement phase 3`

---

### Phase 4: Timeout Transitions (T024-T029)

**Goal**: Add tick tracking and timeout detection to SocialAgent

| Task | Type | Description |
|------|------|-------------|
| T024 | TEST | Write tests for `SocialAgent.tick()` |
| T025 | IMPL | Add `tick()` method to `SocialAgent` |
| T026 | TEST | Write tests for `SocialAgent.is_timed_out()` |
| T027 | IMPL | Add `is_timed_out()` method to `SocialAgent` |
| T028 | TEST | Write tests for timeout_threshold parameter |
| T029 | IMPL | Add `timeout_threshold` parameter to `SocialAgent.__init__()` |

**Command**: `/implement phase 4`

---

### Phase 5: Agent Integration (T030-T039)

**Goal**: Integrate statechart with SocialAgent (state, history, transition_to)

| Task | Type | Description |
|------|------|-------------|
| T030 | TEST | Write tests for `SocialAgent.state` field |
| T031 | IMPL | Add `state` field to `SocialAgent` |
| T032 | TEST | Write tests for `SocialAgent.state_history` field |
| T033 | IMPL | Add `state_history` field to `SocialAgent` |
| T034 | TEST | Write tests for `SocialAgent.transition_to()` |
| T035 | IMPL | Implement `transition_to()` method |
| T036 | TEST | Write tests for history pruning |
| T037 | IMPL | Implement history pruning in `transition_to()` |
| T038 | TEST | Write tests for `engagement_threshold` parameter |
| T039 | IMPL | Add `engagement_threshold` and `should_engage()` |

**Command**: `/implement phase 5`

---

### Phase 6: Queries + Validation (T040-T047)

**Goal**: Add query functions, package exports, integration test, spec tests

| Task | Type | Description |
|------|------|-------------|
| T040 | TEST | Write tests for `agents_in_state()` |
| T041 | IMPL | Implement `agents_in_state()` in `prism/statechart/queries.py` |
| T042 | TEST | Write tests for `state_distribution()` |
| T043 | IMPL | Implement `state_distribution()` |
| T044 | IMPL | Create `prism/statechart/__init__.py` with exports |
| T045 | IMPL | Create `tests/statechart/__init__.py` |
| T046 | TEST | Write integration test |
| T047 | SPEC | Run spec tests |

**Command**: `/implement phase 6`

---

## Parallel Execution Strategy

Based on the dependency graph, here's the optimal execution order:

### Wave 1
- **Phase 1**: Core Types (no dependencies)

### Wave 2
- **Phase 2**: Statechart Engine (depends on Phase 1)

### Wave 3 (can run in parallel)
- **Phase 3**: LLM Reasoner (depends on Phase 2)
- **Phase 4**: Timeout Transitions (depends on Phase 2)

### Wave 4
- **Phase 5**: Agent Integration (depends on Phase 4)

### Wave 5
- **Phase 6**: Queries + Validation (depends on Phase 5)

**Parallel command for Wave 3**: `/implement-agents phase 3 phase 4`

## Quick Commands Reference

| Action | Command |
|--------|---------|
| Implement Phase 1 | `/implement phase 1` |
| Implement Phase 2 | `/implement phase 2` |
| Implement Phases 3+4 in parallel | `/implement-agents phase 3 phase 4` |
| Implement Phase 5 | `/implement phase 5` |
| Implement Phase 6 | `/implement phase 6` |
| Run all unit tests | `uv run pytest tests/statechart/` |
| Run spec tests | `/spec-tests specs/tests/003-agent-behavior-statecharts.md` |
| Check linting | `uv run ruff check . && uv run flake8 .` |
| Format check | `uv run black --check .` |

## Success Criteria

- [ ] All 47 tasks completed
- [ ] `uv run ruff check .` passes
- [ ] `uv run flake8 .` passes
- [ ] `uv run black --check .` passes
- [ ] `uv run pytest` passes (all tests)
- [ ] Spec tests pass (`specs/tests/003-agent-behavior-statecharts.md`)

## Manual Testing Strategy

After Phase 6 completion:

1. **Smoke test**: Create an agent and verify `agent.state` is `AgentState.IDLE`
2. **Transition test**: Fire transitions and verify `state_history` records them
3. **Timeout test**: Increment `ticks_in_state` and verify `is_timed_out()` works
4. **Query test**: Create multiple agents and verify `state_distribution()` counts correctly

## Files to Create/Modify

### New Files
| File | Phase |
|------|-------|
| `prism/statechart/__init__.py` | 6 |
| `prism/statechart/states.py` | 1 |
| `prism/statechart/transitions.py` | 1 |
| `prism/statechart/statechart.py` | 2 |
| `prism/statechart/reasoner.py` | 3 |
| `prism/statechart/queries.py` | 6 |
| `tests/statechart/__init__.py` | 6 |
| `tests/statechart/test_states.py` | 1 |
| `tests/statechart/test_transitions.py` | 1 |
| `tests/statechart/test_statechart.py` | 2 |
| `tests/statechart/test_reasoner.py` | 3 |
| `tests/statechart/test_queries.py` | 6 |
| `tests/statechart/test_integration.py` | 6 |

### Modified Files
| File | Phase |
|------|-------|
| `prism/agents/social_agent.py` | 4, 5 |

## Next Action

üöÄ **Start Phase 1: Core Types**

```
/implement phase 1
```

This will implement T001-T006:
- AgentState enum with all behavioral states
- Transition dataclass with guard/action support
- StateTransition record for history tracking
