<!-- Auto-generated by /work-plan - Updated: 2026-01-31T08:15:00Z -->

# Work Plan: Feature 004 - Simulation Workflow Loop

## Current Status

| Attribute | Value |
|-----------|-------|
| Feature | 004-simulation-workflow-loop |
| Branch | `feature/004-simulation-workflow-loop` âœ“ |
| Progress | 62/149 tasks (41.6%) |
| Current Phase | Phase 3: Executors |
| Status | ğŸ”„ Ready to Start |

## Phase Overview

| Phase | Name | Status | Progress | Blocks | Tasks |
|-------|------|--------|----------|--------|-------|
| 1 | State Foundation | âœ… Complete | 28/28 (100%) | - | T001-T028 |
| 2 | Triggers & Factory | âœ… Complete | 34/34 (100%) | - | T029-T062 |
| 3 | Executors | ğŸ”„ Ready | 0/38 | - | T063-T100 |
| 4 | Controller & Checkpoint | ğŸ”„ Ready | 0/32 | - | T101-T132 |
| 5 | Integration | â¸ï¸ Blocked | 0/17 | Phase 3, 4 | T133-T149 |

## Dependencies

```
Phase 1 (State Foundation)
    â”‚
    â–¼
Phase 2 (Triggers & Factory)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                   â–¼
Phase 3 (Executors)  Phase 4 (Controller & Checkpoint)
    â”‚                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
        Phase 5 (Integration)
```

## Recommended Execution Plan

### Wave 1: Foundation (Sequential) âœ… COMPLETE

| Phase | Command | Goal | Status |
|-------|---------|------|--------|
| Phase 1 | `/implement 1 004` | SimulationConfig, EngagementMetrics, SimulationState, result types | âœ… Done |
| Phase 2 | `/implement 2 004` | determine_trigger(), create_social_media_statechart() | âœ… Done |

### Wave 2: Pipeline Components (Parallel) â† CURRENT

Phase 3 and Phase 4 can run in parallel now:

```bash
/implement-agents phase 3 phase 4 004
```

| Phase | Focus | Status |
|-------|-------|--------|
| Phase 3 | Feed, Decision, StateUpdate, Logging, AgentRound executors | ğŸ”„ Ready |
| Phase 4 | Checkpointer, RoundController | ğŸ”„ Ready |

### Wave 3: Integration (Sequential)

| Phase | Command | Goal |
|-------|---------|------|
| Phase 5 | `/implement 5 004` | Config integration, module exports, integration tests, entry point |

## Quick Commands Reference

| Action | Command |
|--------|---------|
| Run Phase 3 & 4 parallel | `/implement-agents phase 3 phase 4 004` |
| Start Phase 3 only | `/implement 3 004` |
| Start Phase 4 only | `/implement 4 004` |
| Check progress | `/work-plan 004` |
| Run unit tests | `uv run pytest tests/simulation/` |
| Run spec tests | `/spec-tests` |
| Lint check | `uv run ruff check . && uv run ruff format --check .` |

## Phase Details

### Phase 1: State Foundation (T001-T028)

**Goal**: Core data models for simulation state management

**Components**:
- `SimulationConfig` - YAML-driven configuration (T001-T006)
- `EngagementMetrics` - Cumulative engagement tracking (T007-T010)
- `SimulationState` - Central state container (T011-T020)
- Result types: `ActionResult`, `DecisionResult`, `RoundResult`, `SimulationResult` (T021-T028)

**New Files**:
- `prism/simulation/__init__.py`
- `prism/simulation/config.py`
- `prism/simulation/state.py`
- `tests/simulation/test_config.py`
- `tests/simulation/test_state.py`

### Phase 2: Triggers & Statechart Factory (T029-T062)

**Goal**: Trigger determination and default statechart definition

**Components**:
- `determine_trigger()` - Maps agent state + context to trigger (T029-T044)
- `create_social_media_statechart()` - Factory for default transitions (T045-T062)

**New Files**:
- `prism/simulation/triggers.py`
- `prism/simulation/statechart_factory.py`
- `tests/simulation/test_triggers.py`
- `tests/simulation/test_statechart_factory.py`

### Phase 3: Executors (T063-T100)

**Goal**: Pipeline executors for agent rounds

**Components**:
- `FeedRetrievalExecutor` - Wraps FeedRetriever (T063-T066)
- `AgentDecisionExecutor` - Statechart-driven decisions (T067-T080)
- `StateUpdateExecutor` - Applies actions to state (T081-T090)
- `LoggingExecutor` - Structured JSON logging (T091-T096)
- `AgentRoundExecutor` - Coordinates pipeline (T097-T100)

**New Files**:
- `prism/simulation/executors/__init__.py`
- `prism/simulation/executors/base.py`
- `prism/simulation/executors/feed.py`
- `prism/simulation/executors/decision.py`
- `prism/simulation/executors/state_update.py`
- `prism/simulation/executors/logging.py`
- `tests/simulation/executors/` (corresponding test files)

### Phase 4: Controller & Checkpoint (T101-T132)

**Goal**: Round orchestration and state persistence

**Components**:
- `Checkpointer` - JSON checkpoint save/load (T101-T116)
- `RoundController` - Orchestrates rounds (T117-T132)

**New Files**:
- `prism/simulation/checkpointer.py`
- `prism/simulation/controller.py`
- `tests/simulation/test_checkpointer.py`
- `tests/simulation/test_controller.py`

### Phase 5: Integration (T133-T149)

**Goal**: End-to-end integration and entry point

**Components**:
- Config integration with `configs/default.yaml` (T133-T136)
- Module exports (T137-T140)
- Integration tests (T141-T146)
- Entry point in `main.py` (T147-T148)
- Spec tests validation (T149)

**Modified Files**:
- `configs/default.yaml`
- `main.py`

## Success Criteria

- [ ] All 149 tasks completed
- [ ] `uv run ruff check .` passes
- [ ] `uv run ruff format --check .` passes
- [ ] `uv run pytest tests/simulation/` passes
- [ ] Spec tests pass (`specs/tests/004-simulation-workflow-loop.md`)
- [ ] Integration test: 3 agents Ã— 2 rounds completes
- [ ] Checkpoint/resume produces same state

## Manual Testing Strategy

| Phase | What to Test Manually |
|-------|----------------------|
| Phase 3 | Decision executor with mock statechart |
| Phase 4 | Checkpoint file format, resume behavior |
| Phase 5 | Full simulation run, verify JSON logs |

## Next Action

ğŸš€ **Run Phase 3 and Phase 4 in Parallel**

```bash
/implement-agents phase 3 phase 4 004
```

**Phase 3** (T063-T100): Executors
- FeedRetrievalExecutor, AgentDecisionExecutor, StateUpdateExecutor
- LoggingExecutor, AgentRoundExecutor

**Phase 4** (T101-T132): Controller & Checkpoint
- Checkpointer (save/load/atomic write)
- RoundController (iteration, checkpoint frequency, resume)

After both complete, run Phase 5 for integration.
